version: '3.4'
services:
  consul:
    logging: &logging
      driver: loki-compose
      options:
        loki-url: "http://localhost:8007/loki/api/v1/push"
        loki-retries: "1"
        loki-tenant-id: "1"
    image: consul
    command: [ "agent", "-dev" ,"-client=0.0.0.0", "-log-level=info" ]
    ports:
      - 8500:8500

  minio:
    logging:
      <<: *logging
    image: minio/minio:RELEASE.2022-03-11T23-57-45Z
    entrypoint: sh
    command: -c 'mkdir -p /data/loki && /opt/bin/minio server --console-address :9001 /data'
    environment:
      - MINIO_ACCESS_KEY=loki
      - MINIO_SECRET_KEY=supersecret
    ports:
      - 9000:9000
      - 9001:9001
    volumes:
      - .data-minio:/data:delegated

  memcached:
    logging:
      <<: *logging
    image: memcached:1.6

  jaeger:
    logging:
      <<: *logging
    image: jaegertracing/all-in-one
    ports:
      - 16686:16686
      - "14268"

  loki:
    logging:
      <<: *logging
    build:
      context:    .
      dockerfile: dev.dockerfile
    image: loki
    command: ["sh", "-c", "sleep 3 && exec ./dlv exec ./loki --listen=:18007 --headless=true --api-version=2 --accept-multiclient --continue -- -config.file=./config/loki.yaml -target=all -log.level=debug"]
    depends_on:
      - consul
      - minio
    environment:
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - JAEGER_TAGS=app=query-frontend
      - JAEGER_SAMPLER_TYPE=const
      - JAEGER_SAMPLER_PARAM=1
    ports:
      - 8007:8007
      - 18007:18007
    volumes:
      - ./config:/loki/config

  grafana:
    logging:
      <<: *logging
    image: jeschkies/grafana:hackathon-eli5-c640cae281
    depends_on:
      - loki
    environment:
      - GF_PATHS_PROVISIONING=/etc/config/grafana/provisioning
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    ports:
      - 3000:3000
    volumes:
      - ./config/datasource.yaml:/etc/config/grafana/provisioning/datasources/ds.yaml

  log-gen:
    logging:
      <<: *logging
    image: mingrammer/flog
    command: ["-f", "json", "-l", "-d", "2s"]
    depends_on:
      - loki

  log-gen-2:
    logging:
      driver: loki-compose
      options:
        loki-url: "http://localhost:8001/loki/api/v1/push"
        loki-retries: "1"
        loki-tenant-id: "2"
    image: mingrammer/flog
    command: ["-f", "json", "-l", "-d", "2s"]
    depends_on:
      - loki
